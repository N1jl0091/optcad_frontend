<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Your Strava Rides</title>
<style>
  body { font-family: Arial; padding: 1rem; }
  button { margin-left: 1rem; padding: 0.3rem 0.6rem; }
  ul { list-style:none; padding:0; }
  li { margin-bottom:0.7rem; }
  #loading { font-style:italic; }
</style>
</head>
<body>
<h1>Your Recent Bike Rides</h1>
<div id="loading">Loading activities...</div>
<ul id="ride-list"></ul>

<script>
const params = new URLSearchParams(window.location.search);
const sessionId = params.get("session_id");
const list = document.getElementById("ride-list");
const loadingDiv = document.getElementById("loading");
const BACKEND_URL = "https://optcadbackend-production.up.railway.app";

if (!sessionId) document.body.innerHTML = "<p>Session ID missing in URL.</p>";
else {
  fetch(`${BACKEND_URL}/activities?session_id=${sessionId}`)
    .then(res => res.json())
    .then(data => {
      loadingDiv.style.display = "none";
      if (!Array.isArray(data)) return list.innerHTML="<li>No rides found</li>";
      data.forEach(ride=>{
        const li=document.createElement("li");
        const name=ride.name||"Unnamed Ride";
        const km=(ride.distance/1000).toFixed(2);
        const date=ride.start_date?new Date(ride.start_date).toLocaleDateString():"Unknown Date";
        const button=document.createElement("button");
        button.textContent="Compute";
        button.onclick=()=>computeRide(ride.id, button);
        li.textContent=`${name} â€” ${km} km on ${date} `;
        li.appendChild(button);
        list.appendChild(li);
      });
    });
}

function computeRide(activityId, button){
  button.disabled=true;
  button.textContent="Processing...";
  fetch(`${BACKEND_URL}/compute?session_id=${sessionId}&activity_id=${activityId}`)
    .then(res=>res.json())
    .then(data=>{
      console.log("Computed ride:", data);
      alert(`Optimal cadence: ${data.optimal_cadence.toFixed(1)}\nSegments: ${data.segments.length}`);
    })
    .finally(()=>{
      button.disabled=false;
      button.textContent="Compute";
    });
}
</script>
</body>
</html>

